<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Processor Configuration</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.crowdin.com/apps/dist/iframe.js" defer></script>
    <script src="app.js" defer></script>
</head>
<body>
    <!-- Main Container -->
    <div class="container" role="main">
        <h1>üìÅ File Processor Configuration</h1>
        
        <!-- Introduction Section -->
        <div class="tool-section">
            <h3>üöÄ Welcome to Crowdin File Processor Template</h3>
            <p>This template demonstrates a fully functional Crowdin app with <strong>File Processing</strong> modules that intercept and transform files during import/export workflows.</p>
            
            <div class="context-info">
                <strong>üìå About File Processing Modules:</strong><br>
                File Processor apps provide hooks at four critical stages: pre-import, post-import, pre-export, and post-export. 
                Each module can transform content using regex replacement rules, enabling powerful text transformations without modifying the core Crowdin functionality.
            </div>
            
            <h4>What's Included in This Template:</h4>
            <ul class="feature-list">
                <li><strong>Pre-Import Module</strong> - Transform raw file content before Crowdin parsing</li>
                <li><strong>Post-Import Module</strong> - Transform parsed strings before storage (supports plurals)</li>
                <li><strong>Pre-Export Module</strong> - Transform translations before file generation (supports plurals)</li>
                <li><strong>Post-Export Module</strong> - Transform final file content after generation</li>
                <li><strong>Configuration UI</strong> - Web interface for managing regex replacement rules</li>
                <li><strong>Metadata Storage</strong> - Organization-level configuration persistence</li>
                <li><strong>TypeScript Support</strong> - Type-safe backend development</li>
                <li><strong>Cloudflare Workers Ready</strong> - Optimized for edge deployment</li>
            </ul>

            <div class="info-box">
                <strong>üí° Getting Started:</strong><br>
                1. Configure regex replacement rules for each module below<br>
                2. Save your configuration (stored at organization level)<br>
                3. Rules will be applied automatically during file operations<br>
                4. Check <code>worker/app.ts</code> to customize processing logic
            </div>
        </div>

        <!-- Module Enable/Disable Section -->
        <div class="tool-section" role="region" aria-labelledby="modules-heading">
            <h3 id="modules-heading">‚öôÔ∏è Module Configuration</h3>
            <p>Enable or disable each processing module:</p>
            
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="modulePreImport" checked>
                    <span>üì• Pre-Import Module</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="modulePostImport" checked>
                    <span>üìù Post-Import Module</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="modulePreExport" checked>
                    <span>üì§ Pre-Export Module</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="modulePostExport" checked>
                    <span>üì¶ Post-Export Module</span>
                </label>
            </div>
        </div>

        <!-- Pre-Import Rules Section -->
        <div class="tool-section" role="region" aria-labelledby="preimport-heading">
            <h3 id="preimport-heading">üì• Pre-Import Replacement Rules</h3>
            <p>Define regex patterns to transform raw file content before Crowdin parses it:</p>
            
            <div class="form-group">
                <label>Replacement Rules:</label>
                <div id="preImportRules" class="rules-list"></div>
                <div class="rule-add-form">
                    <input type="text" id="preImportFind" placeholder="Find (regex)" class="form-input">
                    <input type="text" id="preImportReplace" placeholder="Replace with" class="form-input">
                    <button onclick="addRule('preImport')" class="btn-add">‚ûï Add</button>
                </div>
            </div>
            
            <div class="code-snippet">
                <strong>üìù Common Examples:</strong><br>
                ‚Ä¢ <code>\r\n</code> ‚Üí <code>\n</code> - Normalize line endings<br>
                ‚Ä¢ <code>&lt;placeholder&gt;</code> ‚Üí <code>&lt;text&gt;</code> - Replace placeholders<br>
                ‚Ä¢ <code>^\s+</code> ‚Üí <code></code> - Remove leading whitespace
            </div>
        </div>

        <!-- Post-Import Rules Section -->
        <div class="tool-section" role="region" aria-labelledby="postimport-heading">
            <h3 id="postimport-heading">üìù Post-Import Replacement Rules</h3>
            <p>Define regex patterns to transform parsed string text (including plural forms):</p>
            
            <div class="form-group">
                <label>Replacement Rules:</label>
                <div id="postImportRules" class="rules-list"></div>
                <div class="rule-add-form">
                    <input type="text" id="postImportFind" placeholder="Find (regex)" class="form-input">
                    <input type="text" id="postImportReplace" placeholder="Replace with" class="form-input">
                    <button onclick="addRule('postImport')" class="btn-add">‚ûï Add</button>
                </div>
            </div>
            
            <div class="code-snippet">
                <strong>üìù Common Examples:</strong><br>
                ‚Ä¢ <code>&amp;nbsp;</code> ‚Üí <code> </code> - Replace HTML entities<br>
                ‚Ä¢ <code>^(.+)$</code> ‚Üí <code>[NEEDS_REVIEW]$1</code> - Add prefix to all strings<br>
                ‚Ä¢ <code>\s+</code> ‚Üí <code> </code> - Normalize whitespace
            </div>
        </div>

        <!-- Pre-Export Rules Section -->
        <div class="tool-section" role="region" aria-labelledby="preexport-heading">
            <h3 id="preexport-heading">üì§ Pre-Export Replacement Rules</h3>
            <p>Define regex patterns to transform translations for all target languages:</p>
            
            <div class="form-group">
                <label>Replacement Rules:</label>
                <div id="preExportRules" class="rules-list"></div>
                <div class="rule-add-form">
                    <input type="text" id="preExportFind" placeholder="Find (regex)" class="form-input">
                    <input type="text" id="preExportReplace" placeholder="Replace with" class="form-input">
                    <button onclick="addRule('preExport')" class="btn-add">‚ûï Add</button>
                </div>
            </div>
            
            <div class="code-snippet">
                <strong>üìù Common Examples:</strong><br>
                ‚Ä¢ <code>^[NEEDS_REVIEW]</code> ‚Üí <code></code> - Remove import prefix<br>
                ‚Ä¢ <code>(\d+)\.(\d+)</code> ‚Üí <code>$1,$2</code> - Change decimal separator<br>
                ‚Ä¢ <code>\{(\w+)\}</code> ‚Üí <code>{{$1}}</code> - Transform placeholder format
            </div>
        </div>

        <!-- Post-Export Rules Section -->
        <div class="tool-section" role="region" aria-labelledby="postexport-heading">
            <h3 id="postexport-heading">üì¶ Post-Export Replacement Rules</h3>
            <p>Define regex patterns to transform final exported file content:</p>
            
            <div class="form-group">
                <label>Replacement Rules:</label>
                <div id="postExportRules" class="rules-list"></div>
                <div class="rule-add-form">
                    <input type="text" id="postExportFind" placeholder="Find (regex)" class="form-input">
                    <input type="text" id="postExportReplace" placeholder="Replace with" class="form-input">
                    <button onclick="addRule('postExport')" class="btn-add">‚ûï Add</button>
                </div>
            </div>
            
            <div class="code-snippet">
                <strong>üìù Common Examples:</strong><br>
                ‚Ä¢ <code>^</code> ‚Üí <code>&lt;!-- Generated by Crowdin --&gt;\n</code> - Add header<br>
                ‚Ä¢ <code>\n</code> ‚Üí <code>\r\n</code> - Convert line endings<br>
                ‚Ä¢ <code>&lt;text&gt;</code> ‚Üí <code>&lt;final&gt;</code> - Final text replacement
            </div>
        </div>

        <!-- Save Configuration Section -->
        <div class="tool-section" role="region" aria-labelledby="save-heading">
            <h3 id="save-heading">üíæ Save Configuration</h3>
            <p>Apply your replacement rules configuration to the organization:</p>
            
            <div style="margin: 20px 0;" role="group" aria-label="Configuration actions">
                <button class="action-button" 
                        onclick="saveConfiguration()" 
                        aria-label="Save configuration">
                    üíæ Save Configuration
                </button>
                <button class="action-button" 
                        onclick="loadConfiguration()" 
                        aria-label="Reload configuration">
                    üîÑ Reload
                </button>
            </div>
            
            <div id="saveResult" role="status" aria-live="polite"></div>
            
            <div class="code-snippet">
                <strong>Backend Code (worker/app.ts):</strong><br>
                const configKey = `file_processor_config_${organizationId}`;<br>
                await crowdinModule.metadataStore.saveMetadata(configKey, config, connection.context.crowdinId);<br>
                // Configuration is saved at organization level
            </div>
        </div>

        <!-- Current Status Section -->
        <div class="tool-section" role="region" aria-labelledby="status-heading">
            <h3 id="status-heading">üìä Current Status</h3>
            <p>View your current file processor configuration and organization context:</p>
            <div id="statusInfo" class="loading" role="status" aria-live="polite">Loading configuration...</div>
            
            <div class="code-snippet">
                <strong>Code Example:</strong><br>
                const config = await crowdinModule.metadataStore.getMetadata(configKey);<br>
                const rules = config?.preImport?.replaceRules || [];
            </div>
        </div>

        <!-- How It Works Section -->
        <div class="tool-section" role="region" aria-labelledby="workflow-heading">
            <h3 id="workflow-heading">üîß How It Works</h3>
            
            <h4>Import Processing Workflow:</h4>
            <ol class="feature-list">
                <li><strong>File Upload:</strong> User uploads a file to Crowdin via UI or API</li>
                <li><strong>Pre-Import Hook:</strong> <code>filePreImport.fileProcess()</code> receives raw file content as Buffer</li>
                <li><strong>Content Transformation:</strong> Regex rules are applied to file content, returns modified Buffer</li>
                <li><strong>Crowdin Parsing:</strong> Modified file is parsed into strings by Crowdin's parser</li>
                <li><strong>Post-Import Hook:</strong> <code>filePostImport.fileProcess()</code> receives parsed strings array</li>
                <li><strong>String Transformation:</strong> Regex rules are applied to string text (including all plural forms)</li>
                <li><strong>Storage:</strong> Modified strings are stored in Crowdin database</li>
            </ol>
            
            <h4>Export Processing Workflow:</h4>
            <ol class="feature-list">
                <li><strong>Export Request:</strong> User requests file export from Crowdin</li>
                <li><strong>Fetch Translations:</strong> Crowdin retrieves strings with translations for target languages</li>
                <li><strong>Pre-Export Hook:</strong> <code>filePreExport.fileProcess()</code> receives strings with translations</li>
                <li><strong>Translation Transformation:</strong> Regex rules are applied to translations (all languages, all plural forms)</li>
                <li><strong>File Generation:</strong> Crowdin generates file from modified translations</li>
                <li><strong>Post-Export Hook:</strong> <code>filePostExport.fileProcess()</code> receives generated file as Buffer</li>
                <li><strong>Content Transformation:</strong> Regex rules are applied to final file content</li>
                <li><strong>Delivery:</strong> Modified file is delivered to user</li>
            </ol>
            
            <div class="code-snippet">
                <strong>Processing Function Example (worker/app.ts):</strong><br>
                fileProcess: async (req, content, client, context, projectId) => {<br>
                &nbsp;&nbsp;const config = await getConfig(context.organizationId);<br>
                &nbsp;&nbsp;if (!config.modules.preImport) return { notModified: true };<br>
                &nbsp;&nbsp;<br>
                &nbsp;&nbsp;let contentString = content.toString('utf-8');<br>
                &nbsp;&nbsp;contentString = applyReplaceRules(contentString, config.rules);<br>
                &nbsp;&nbsp;return { contentFile: Buffer.from(contentString) };<br>
                }
            </div>
        </div>

        <!-- Important Notes Section -->
        <div class="tool-section">
            <h3>‚ö†Ô∏è Important Notes</h3>
            <ul class="feature-list">
                <li>Configuration is applied at the <strong>organization level</strong> for all projects</li>
                <li><strong>Pre-Import</strong> and <strong>Post-Export</strong> work with raw file content (Buffer)</li>
                <li><strong>Post-Import</strong> works with source string text only (not identifiers or context)</li>
                <li><strong>Pre-Export</strong> works with translations for all target languages</li>
                <li>Plural forms are automatically processed in Post-Import and Pre-Export modules</li>
                <li>Regex patterns use JavaScript RegExp syntax with global flag</li>
                <li>Invalid regex patterns will be skipped with error logging</li>
                <li>Rules are applied in order (top to bottom)</li>
            </ul>

            <div class="info-box">
                <strong>üéØ Pro Tips:</strong><br>
                ‚Ä¢ Use capturing groups <code>(...)</code> to preserve parts of matched text<br>
                ‚Ä¢ Reference captured groups in replacement with <code>$1</code>, <code>$2</code>, etc.<br>
                ‚Ä¢ Test regex patterns with sample files before production deployment<br>
                ‚Ä¢ Disable unused modules to improve performance<br>
                ‚Ä¢ For complex transformations, modify <code>worker/app.ts</code> directly
            </div>
        </div>

        <!-- Implementation Guide -->
        <div class="tool-section">
            <h3>üìö Implementation Guide</h3>
            
            <h4>Frontend (app.js):</h4>
            <div class="code-snippet">
                ‚Ä¢ Use <code>AP.getContext()</code> to get organization information<br>
                ‚Ä¢ Use <code>AP.getJwtToken()</code> to authenticate API calls<br>
                ‚Ä¢ Make requests to <code>/api/config</code> to manage configuration<br>
                ‚Ä¢ Configuration includes modules state and replaceRules arrays<br>
                ‚Ä¢ Update UI dynamically based on saved configuration
            </div>

            <h4>Backend (worker/app.ts):</h4>
            <div class="code-snippet">
                ‚Ä¢ Four file processing modules: <code>filePreImport</code>, <code>filePostImport</code>, <code>filePreExport</code>, <code>filePostExport</code><br>
                ‚Ä¢ Each module has <code>signaturePatterns</code> to match file types<br>
                ‚Ä¢ <code>fileProcess</code> function receives content and returns transformed result<br>
                ‚Ä¢ Helper function <code>applyReplaceRules()</code> applies regex transformations<br>
                ‚Ä¢ Configuration stored in metadata storage with key pattern: <code>file_processor_config_{orgId}</code><br>
                ‚Ä¢ Supports plural forms automatically via <code>SourceStringsModel.PluralText</code> type
            </div>

            <h4>Next Steps:</h4>
            <ul class="feature-list">
                <li>Configure your replacement rules using the forms above</li>
                <li>Test with sample files in a development project</li>
                <li>Customize <code>worker/app.ts</code> for advanced transformations</li>
                <li>Add additional modules or extend existing functionality</li>
                <li>Deploy to Cloudflare Workers and install in your Crowdin organization</li>
            </ul>
        </div>

        <!-- Documentation Link -->
        <div class="tool-section">
            <h3>üìñ Documentation & Resources</h3>
            <p>
                <strong>File Pre-Import Module:</strong><br>
                <a href="https://crowdin.github.io/app-project-module/file-processor/pre-import/" target="_blank" rel="noopener">
                    https://crowdin.github.io/app-project-module/file-processor/pre-import/
                </a>
            </p>
            <p>
                <strong>File Post-Import Module:</strong><br>
                <a href="https://crowdin.github.io/app-project-module/file-processor/post-import/" target="_blank" rel="noopener">
                    https://crowdin.github.io/app-project-module/file-processor/post-import/
                </a>
            </p>
            <p>
                <strong>File Pre-Export Module:</strong><br>
                <a href="https://crowdin.github.io/app-project-module/file-processor/pre-export/" target="_blank" rel="noopener">
                    https://crowdin.github.io/app-project-module/file-processor/pre-export/
                </a>
            </p>
            <p>
                <strong>File Post-Export Module:</strong><br>
                <a href="https://crowdin.github.io/app-project-module/file-processor/post-export/" target="_blank" rel="noopener">
                    https://crowdin.github.io/app-project-module/file-processor/post-export/
                </a>
            </p>
            <p>
                <strong>Crowdin API Client:</strong><br>
                <a href="https://github.com/crowdin/crowdin-api-client-js" target="_blank" rel="noopener">
                    https://github.com/crowdin/crowdin-api-client-js
                </a>
            </p>
            <p>
                <strong>Crowdin Apps Platform:</strong><br>
                <a href="https://developer.crowdin.com/crowdin-apps-about/" target="_blank" rel="noopener">
                    https://developer.crowdin.com/crowdin-apps-about/
                </a>
            </p>
        </div>

    </div>
</body>
</html>
